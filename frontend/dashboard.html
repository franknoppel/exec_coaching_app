<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Coach Dashboard</title>
<style>
  body { margin:0; background:#f9fafb; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; }
  header { display:flex; justify-content:space-between; align-items:center; padding:16px 20px; background:#111827; color:#fff; }
  main { padding:20px; max-width:1200px; margin:0 auto; }
  h2 { margin:16px 0 8px; }
  .grid { display:grid; gap:12px; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); }
  .card { background:#fff; border:1px solid #e5e7eb; border-radius:14px; padding:14px; box-shadow:0 4px 16px rgba(0,0,0,.04); }
  button, .btn { padding:8px 10px; border-radius:10px; border:0; background:#111827; color:#fff; cursor:pointer; }
  .btn.secondary { background:#4b5563; }
  .muted { color:#6b7280; font-size:13px; }
  .list { border:1px solid #e5e7eb; background:#fff; border-radius:12px; }
  .list .row { display:flex; justify-content:space-between; padding:10px 12px; border-top:1px solid #f3f4f6; }
  .list .row:first-child { border-top:none; }
  .pill { display:inline-block; padding:2px 8px; border-radius:999px; font-size:12px; background:#f3f4f6; }
  dialog { border:0; border-radius:16px; width:min(680px, 92vw); }
  dialog::backdrop { background: rgba(0,0,0,.25); }
  .row2 { display:grid; grid-template-columns:1fr 1fr; gap:10px; }
  input, textarea, select { width:100%; padding:8px 10px; border:1px solid #e5e7eb; border-radius:10px; font-size:14px; outline:none; }
  input:focus, textarea:focus { border-color:#6366f1; box-shadow:0 0 0 3px rgba(99,102,241,.15); }
  textarea { min-height:80px; }
  .toolbar { display:flex; gap:10px; margin:8px 0 12px; }
  a.link { color:#111827; }
</style>
</head>
<body>
<header>
  <div><strong>Coach Dashboard</strong></div>
  <div id="userInfo"></div>
</header>

<main>
  <section id="sec1" class="card">
    <h2>1) My Profile</h2>
    <div id="profileBox" class="muted">Loading...</div>
    <div class="toolbar">
      <button id="editProfileBtn" class="btn">Edit Profile</button>
    </div>
  </section>

  <section id="sec2" class="card">
    <h2>2) My Coachees</h2>
    <div id="coacheeGrid" class="grid"></div>
  </section>

  <section id="sec3" class="card">
    <h2>3) My Upcoming/Uncompleted Sessions</h2>
    <div id="openSessions" class="list"></div>
  </section>

  <section id="sec4" class="card">
    <h2>4) Training Module Repository</h2>
    <div class="toolbar"><button id="refreshModules" class="btn secondary">Refresh</button></div>
    <div id="modules" class="list"></div>
  </section>

  <section id="sec5" class="card">
    <h2>5) Feedback Templates</h2>
    <div class="toolbar"><button id="refreshTemplates" class="btn secondary">Refresh</button></div>
    <div id="templates" class="list"></div>
  </section>
</main>

<dialog id="modal">
  <div id="modalBody"></div>
  <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
    <button id="modalClose" class="btn secondary" onclick="modal.close()">Close</button>
  </div>
</dialog>

<script>
const API = localStorage.getItem("apiUrl") || "http://localhost:8000";
const user = JSON.parse(localStorage.getItem("user")||"null");
if(!user){ window.location.href = "index.html"; }
function hdr(){ return {"Content-Type":"application/json","X-User-Id": user.user_id}; }
const modal = document.getElementById("modal");
const body = document.getElementById("modalBody");
document.getElementById("userInfo").textContent = `${user.first_name||""} ${user.last_name||""} (${user.email||""})`;

async function loadProfile(){
  const r = await fetch(API + "/coaches/me",{headers: hdr()});
  const j = await r.json();
  const p = j.profile || {};
  document.getElementById("profileBox").innerHTML = `
    <div><strong>${j.user.first_name||""} ${j.user.last_name||""}</strong> &mdash; ${j.user.email}</div>
    <div class="muted">Qualifications: ${p.qualifications||"-"}</div>
    <div class="muted">Profile: ${p.profile||"-"}</div>`;
  if(!j.profile_exists){ editProfile(j); }
}
async function editProfile(seed){
  const data = seed || await (await fetch(API + "/coaches/me",{headers: hdr()})).json();
  const p = data.profile || {};
  body.innerHTML = `
    <h3>Edit My Profile</h3>
    <div class="row2">
      <div><label>First Name</label><input id="fn" value="${data.user.first_name||""}"></div>
      <div><label>Last Name</label><input id="ln" value="${data.user.last_name||""}"></div>
    </div>
    <div><label>Qualifications</label><textarea id="qual">${p.qualifications||""}</textarea></div>
    <div><label>Profile</label><textarea id="prof">${p.profile||""}</textarea></div>
    <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
      <button class="btn secondary" onclick="modal.close()">Cancel</button>
      <button class="btn" id="saveProf">Save</button>
    </div>`;
  modal.showModal();
  document.getElementById("saveProf").onclick = async ()=>{
    const payload = { first_name: document.getElementById("fn").value, last_name: document.getElementById("ln").value,
                      qualifications: document.getElementById("qual").value, profile: document.getElementById("prof").value };
    await fetch(API + "/coaches/me/profile",{method:"PUT", headers: hdr(), body: JSON.stringify(payload)});
    modal.close(); loadProfile();
  };
}
document.getElementById("editProfileBtn").onclick = ()=>editProfile();

async function loadCoachees(){
  const r = await fetch(API + "/coachees/assigned",{headers: hdr()});
  const j = await r.json();
  const grid = document.getElementById("coacheeGrid"); grid.innerHTML = "";
  for(const c of j.coachees){
    const div = document.createElement("div"); div.className="card";
    div.innerHTML = `<div><strong>${c.first_name||""} ${c.last_name||""}</strong></div>
                     <div class="muted">${c.email}</div>
                     <div class="toolbar"><button class="btn secondary">Details</button></div>`;
    div.querySelector("button").onclick = ()=> showCoacheeDetails(c);
    grid.appendChild(div);
  }
}
async function showCoacheeDetails(c){
  const s = await (await fetch(API + "/sessions",{headers: hdr()})).json();
  const sessions = s.sessions.filter(x => x.coachee_user_id === c.user_id);
  const a = await (await fetch(API + "/assignments/by-coachee/"+c.user_id,{headers: hdr()})).json();
  const f = await (await fetch(API + "/feedback/by-coachee/"+c.user_id,{headers: hdr()})).json();
  function rowifySessions(){
    return sessions.map(x=>`<div class="row"><div>${new Date(x.session_date).toLocaleString()}</div><div>${x.topic||"-"}</div><div><span class="pill">${x.status}</span></div><div><a class="link" href="#" data-id="${x.id}" data-type="view">View</a> | <a class="link" href="#" data-id="${x.id}" data-type="edit">Edit</a> | <a class="link" href="#" data-id="${x.id}" data-type="del">Delete</a></div></div>`).join("") || `<div class="row"><em>No sessions</em></div>`;
  }
  function rowifyAssignments(){
    return a.assignments.map(x=>`<div class="row"><div>Module #${x.module_id}</div><div>Due: ${x.due_date||"-"}</div><div><span class="pill">${x.status}</span></div><div><a class="link" href="#" data-id="${x.id}" data-type="a-edit">Edit</a> | <a class="link" href="#" data-id="${x.id}" data-type="a-del">Delete</a></div></div>`).join("") || `<div class="row"><em>No assignments</em></div>`;
  }
  function rowifyFeedback(){
    return f.feedback.map(x=>`<div class="row"><div>Template #${x.template_id||"-"}</div><div>Due: ${x.due_date||"-"}</div><div><span class="pill">${x.status}</span></div><div><a class="link" href="#" data-id="${x.id}" data-type="f-edit">Edit</a> | <a class="link" href="#" data-id="${x.id}" data-type="f-del">Delete</a></div></div>`).join("") || `<div class="row"><em>No feedback</em></div>`;
  }
  body.innerHTML = `
    <h3>Coachee: ${c.first_name||""} ${c.last_name||""}</h3>
    <p class="muted">${c.email}</p>
    <h4>Sessions</h4>
    <div class="toolbar"><button id="addSess" class="btn">Add Session</button></div>
    <div class="list" id="sessList">${rowifySessions()}</div>
    <h4 style="margin-top:10px;">Module Assignments</h4>
    <div class="toolbar"><button id="addAss" class="btn">Add Assignment</button></div>
    <div class="list" id="assList">${rowifyAssignments()}</div>
    <h4 style="margin-top:10px;">Feedback Requests / Submissions</h4>
    <div class="toolbar"><button id="addFb" class="btn">Add Feedback Request</button></div>
    <div class="list" id="fbList">${rowifyFeedback()}</div>`;
  modal.showModal();
  body.querySelector("#addSess").onclick = async ()=>{
    const when = prompt("ISO datetime (e.g., 2025-12-01T09:00:00Z):", new Date().toISOString());
    if(!when) return;
    const topic = prompt("Topic:")||"";
    await fetch(API+"/sessions",{method:"POST", headers: hdr(), body: JSON.stringify({session_date: when, coachee_user_id: c.user_id, topic})});
    showCoacheeDetails(c);
  };
  body.querySelector("#addAss").onclick = async ()=>{
    const module_id = parseInt(prompt("Module ID (see repository section):")||"1",10);
    const due = prompt("Due date (YYYY-MM-DD):","");
    await fetch(API+"/assignments",{method:"POST", headers: hdr(), body: JSON.stringify({module_id, coachee_user_id: c.user_id, due_date: due||null})});
    showCoacheeDetails(c);
  };
  body.querySelector("#addFb").onclick = async ()=>{
    const template_id = parseInt(prompt("Feedback Template ID (see repo):")||"1",10);
    const due = prompt("Due date (YYYY-MM-DD):","");
    await fetch(API+"/feedback",{method:"POST", headers: hdr(), body: JSON.stringify({template_id, coachee_user_id: c.user_id, due_date: due||null})});
    showCoacheeDetails(c);
  };
  body.querySelectorAll("a.link").forEach(a=>{
    a.onclick = async (e)=>{
      e.preventDefault();
      const id = parseInt(a.dataset.id,10);
      const t = a.dataset.type;
      if(t==="view"||t==="edit"){
        const r = await (await fetch(API+"/sessions/"+id,{headers: hdr()})).json();
        const newTopic = t==="edit" ? prompt("Edit topic:", r.topic||"") : null;
        if(newTopic!==null){
          r.topic = newTopic;
          await fetch(API+"/sessions/"+id,{method:"PUT", headers: hdr(), body: JSON.stringify(r)});
          showCoacheeDetails(c);
        } else if(t==="view"){
          alert(JSON.stringify(r,null,2));
        }
      } else if(t==="del"){
        await fetch(API+"/sessions/"+id,{method:"DELETE", headers: hdr()});
        showCoacheeDetails(c);
      } else if(t==="a-edit"){
        const due = prompt("New due date YYYY-MM-DD (blank to keep):","");
        await fetch(API+"/assignments/"+id,{method:"PUT", headers: hdr(), body: JSON.stringify({due_date: due || undefined})});
        showCoacheeDetails(c);
      } else if(t==="a-del"){
        await fetch(API+"/assignments/"+id,{method:"DELETE", headers: hdr()});
        showCoacheeDetails(c);
      } else if(t==="f-edit"){
        const status = prompt("Status (not_started/ongoing/completed):","ongoing");
        await fetch(API+"/feedback/"+id,{method:"PUT", headers: hdr(), body: JSON.stringify({status})});
        showCoacheeDetails(c);
      } else if(t==="f-del"){
        await fetch(API+"/feedback/"+id,{method:"DELETE", headers: hdr()});
        showCoacheeDetails(c);
      }
    };
  });
}
async function loadOpenSessions(){
  const r1 = await fetch(API + "/sessions?status=not_started",{headers: hdr()});
  const j1 = await r1.json();
  const r2 = await fetch(API + "/sessions?status=ongoing",{headers: hdr()});
  const j2 = await r2.json();
  const rows = [...j1.sessions, ...j2.sessions].sort((a,b)=> new Date(a.session_date) - new Date(b.session_date));
  document.getElementById("openSessions").innerHTML = rows.map(x=>`<div class="row"><div>${new Date(x.session_date).toLocaleString()}</div><div>${x.topic||"-"}</div><div><span class="pill">${x.status}</span></div><div><a class="link" href="#" data-id="${x.id}">Open</a></div></div>`).join("") || `<div class="row"><em>No open sessions</em></div>`;
  document.querySelectorAll("#openSessions a.link").forEach(a=>{
    a.onclick = async (e)=>{
      e.preventDefault();
      const id = parseInt(a.dataset.id,10);
      const r = await (await fetch(API+"/sessions/"+id,{headers: hdr()})).json();
      alert(JSON.stringify(r,null,2));
    };
  });
}
async function loadModules(){
  const r = await fetch(API+"/modules",{headers: hdr()});
  const j = await r.json();
  document.getElementById("modules").innerHTML = j.modules.map(m=>`<div class="row"><div>${m.name}</div><div class="muted">${m.description||""}</div><div><a class="link" href="#" data-id="${m.id}">Edit</a></div></div>`).join("");
  document.querySelectorAll("#modules a.link").forEach(a=>{
    a.onclick = async (e)=>{
      e.preventDefault();
      const id = parseInt(a.dataset.id,10);
      const r = await (await fetch(API+"/modules/"+id,{headers: hdr()})).json();
      body.innerHTML = `
        <h3>Edit Module</h3>
        <div><label>Name</label><input id="mname" value="${r.name||""}"></div>
        <div><label>Description</label><textarea id="mdesc">${r.description||""}</textarea></div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
          <button class="btn secondary" onclick="modal.close()">Cancel</button>
          <button class="btn" id="saveM">Save</button>
        </div>`;
      modal.showModal();
      document.getElementById("saveM").onclick = async ()=>{
        await fetch(API+"/modules/"+id,{method:"PUT", headers: hdr(), body: JSON.stringify({name: document.getElementById("mname").value, description: document.getElementById("mdesc").value})});
        modal.close(); loadModules();
      };
    };
  });
}
async function loadTemplates(){
  const r = await fetch(API+"/feedback-templates",{headers: hdr()});
  const j = await r.json();
  document.getElementById("templates").innerHTML = j.templates.map(t=>`<div class="row"><div>${t.name}</div><div class="muted">${t.description||""}</div><div><a class="link" href="#" data-id="${t.id}">Edit</a></div></div>`).join("");
  document.querySelectorAll("#templates a.link").forEach(a=>{
    a.onclick = async (e)=>{
      e.preventDefault();
      const id = parseInt(a.dataset.id,10);
      const r = await (await fetch(API+"/feedback-templates/"+id,{headers: hdr()})).json();
      body.innerHTML = `
        <h3>Edit Feedback Template</h3>
        <div><label>Name</label><input id="tname" value="${r.name||""}"></div>
        <div><label>Description</label><textarea id="tdesc">${r.description||""}</textarea></div>
        <div style="display:flex; gap:8px; justify-content:flex-end; margin-top:10px;">
          <button class="btn secondary" onclick="modal.close()">Cancel</button>
          <button class="btn" id="saveT">Save</button>
        </div>`;
      modal.showModal();
      document.getElementById("saveT").onclick = async ()=>{
        await fetch(API+"/feedback-templates/"+id,{method:"PUT", headers: hdr(), body: JSON.stringify({name: document.getElementById("tname").value, description: document.getElementById("tdesc").value})});
        modal.close(); loadTemplates();
      };
    };
  });
}
loadProfile(); loadCoachees(); loadOpenSessions(); loadModules(); loadTemplates();
</script>
</body>
</html>
